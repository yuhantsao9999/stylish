<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>product_id_page</title>
    <link rel="stylesheet" href="./css/product.css" />
    <script src="./src/bootstrap-input-spinner.js"></script>

</head>

<body>
    <div id="header">
        <div class="container clearfix" style="width:100vw; height: 100px;">
            <div id="logo">
                <a href="./index.html"> <img src="./img/logo.png" alt="logo"></a>
            </div>
            <div id="nav">
                <ul class="clearfix">
                    <li class="boundary">
                        <a href="#">女裝</a></li>
                    <li class="boundary">
                        <a href="#">男裝</a></li>
                    <li>
                        <a href="#">配件</a></li>
                </ul>
            </div>
            <div id="nav2">
                <div class="search">
                    <div class="search_i">
                        <img src="./img/search.png" alt="search">
                        <i class="a-icon a-icon-search">
                            </i></div>
                </div>
                <div class="cart">
                    <a href="#"><img src="./img/cart-hover.png" alt=""><img src="./img/cart.png" alt=""></a>
                </div>
                <div class="member">
                    <a href="./sign_in.html"><img src="./img/member-hover.png" alt="">
                        <img src="./img/member.png"></a>
                </div>
            </div>
        </div>
    </div>
    <div class="content">

        <div class=black></div>

        <div class="toptitle">
            <div class="container">
                <h1></h1>
            </div>
        </div>
        <div class="container">
            <div class="introduction">
                <img class="main_image" src="" alt="">
                <div class="detail">
                    <div id="title"></div>
                    <div id="id"></div>
                    <div id=price></div>
                    <div class="blackline"></div>
                    <div id="color">顏色 |
                        <div class="color_item">
                        </div>
                    </div>
                    <div id="size">尺寸 |
                        <!-- <div class="size_item_1">哈</div> -->
                        <!-- <div class="size_item_2">
                            <div class="size_word_2"></div>
                        </div> -->
                    </div>
                    <div id="stock">數
                        <!-- <div class="square"> -->
                        <div>量</div>
                        <div class="space">|</div>
                        <input class="Bootstrap" type="number" value="1" min="1" max="5" step="1" />
                        <!-- <div class="negative">-</div> -->
                        <!-- <div classs="positive">+</div> -->
                        <!-- </div> -->
                    </div>

                    <button type="button" class="add_cart">加入購物車</button>
                    <div class="more_detail">
                        <div>實品顏色依單品照為主</div>
                        <div id="texture"></div>
                        <div>厚薄:薄</div>
                        <div>彈性:無</div>
                        <div id="wash">清洗:</div>
                        <div id="place">產地:</div>
                    </div>
                </div>
            </div>
            <div class="more_info">
                <div class="more">更多產品資訊
                </div>
                <div class="blackline2"></div>
            </div>
            <div class="container">
                <div id="text">O.N.S is all about options, which is why we took our staple polo shirt and upgraded it with slubby linen jersey, making it even lighter for those who prefer their summer style extra-breezy.</div>
                <img id="picture_2" src="" alt="">
                <img id="picture_3" src="" alt="">
            </div>


        </div>
        <!-- <div class="container"> -->
        <!-- <div class="jumbotron">
                <h1>TapPay Fields Bootstrap Example</h1>
                <p class="lead">TapPay Fields 是 三個 host 在 TapPay 的網頁，利用 iframe 的方式嵌入商家網頁，提供安全的卡號輸入方式</p>
            </div> -->
        <form>
            <div class="form-group">
                <label for="exampleInputEmail1">Email address</label>
                <input type="email" class="form-control" id="exampleInputEmail1" placeholder="Email">
            </div>
            <div class="form-group card-number-group">
                <label for="card-number" class="control-label"><span id="cardtype"></span>卡號</label>
                <div class="form-control card-number"></div>
            </div>
            <div class="form-group expiration-date-group">
                <label for="expiration-date" class="control-label">卡片到期日</label>
                <div class="form-control expiration-date" id="tappay-expiration-date"></div>
            </div>
            <div class="form-group cvc-group">
                <label for="cvc" class="control-label">卡片後三碼</label>
                <div class="form-control cvc"></div>
            </div>

            <button type="submit" class="btn_btn-default">Pay</button>
            <!-- <input type="text" class="form-control" id="prime"> -->
        </form>
        <br>
        <!-- <pre class="jumbotron text-left" id="curl">
            </pre> -->
        <!-- </div> -->

        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script src="https://js.tappaysdk.com/tpdirect/v5.1.0"></script>
        <script>
            //設置好金鑰
            TPDirect.setupSDK(12348, 'app_pa1pQcKoY22IlnSXq5m5WP5jFKzoRG58VEXpT7wU62ud7mMbDOGzCYIlzzLF', 'sandbox')
            TPDirect.card.setup({
                    // 把 TapPay 內建輸入卡號的表單給植入到 div 中
                    fields: {
                        number: {
                            element: '.form-control.card-number',
                            placeholder: '**** **** **** ****',
                        },
                        expirationDate: {
                            element: document.getElementById('tappay-expiration-date'),
                            placeholder: 'MM / YY'
                        },
                        ccv: {
                            element: $('.form-control.cvc')[0],
                            placeholder: '後三碼'
                        }
                    },
                    styles: {
                        'input': {
                            'color': 'gray'
                        },
                        'input.ccv': {
                            // 'font-size': '16px'
                        },
                        ':focus': {
                            'color': 'black'
                        },
                        '.valid': {
                            'color': 'green'
                        },
                        '.invalid': {
                            'color': 'red'
                        },
                        '@media screen and (max-width: 400px)': {
                            'input': {
                                'color': 'orange'
                            }
                        }
                    }
                })
                // listen for TapPay Field
            TPDirect.card.onUpdate(function(update) {
                /* Disable / enable submit button depend on update.canGetPrime  */
                /* ============================================================ */
                // update.canGetPrime === true
                //     --> you can call TPDirect.card.getPrime()
                // const submitButton = document.querySelector('button[type="submit"]')
                if (update.canGetPrime) {
                    // submitButton.removeAttribute('disabled')
                    $('button[type="submit"]').removeAttr('disabled')
                } else {
                    // submitButton.setAttribute('disabled', true)
                    $('button[type="submit"]').attr('disabled', true)
                }
                /* Change card type display when card type change */
                /* ============================================== */
                // cardTypes = ['visa', 'mastercard', ...]
                var newType = update.cardType === 'unknown' ? '' : update.cardType
                $('#cardtype').text(newType)
                    /* Change form-group style when tappay field status change */
                    /* ======================================================= */
                    // number 欄位是錯誤的
                if (update.status.number === 2) {
                    setNumberFormGroupToError('.card-number-group')
                } else if (update.status.number === 0) {
                    setNumberFormGroupToSuccess('.card-number-group')
                } else {
                    setNumberFormGroupToNormal('.card-number-group')
                }
                if (update.status.expiry === 2) {
                    setNumberFormGroupToError('.expiration-date-group')
                } else if (update.status.expiry === 0) {
                    setNumberFormGroupToSuccess('.expiration-date-group')
                } else {
                    setNumberFormGroupToNormal('.expiration-date-group')
                }
                if (update.status.cvc === 2) {
                    setNumberFormGroupToError('.cvc-group')
                } else if (update.status.cvc === 0) {
                    setNumberFormGroupToSuccess('.cvc-group')
                } else {
                    setNumberFormGroupToNormal('.cvc-group')
                }
            })
            $('form').on('submit', function(event) {
                event.preventDefault()

                // fix keyboard issue in iOS device
                forceBlurIos()

                const tappayStatus = TPDirect.card.getTappayFieldsStatus()
                console.log(tappayStatus)
                    // Check TPDirect.card.getTappayFieldsStatus().canGetPrime before TPDirect.card.getPrime
                if (tappayStatus.canGetPrime === false) {
                    alert('can not get prime')
                    return
                }
                // Get prime
                TPDirect.card.getPrime(function(result) {
                    if (result.status !== 0) {
                        alert('get prime error ' + result.msg)
                        return
                    }

                    alert('get prime 成功，prime: ' + result.card.prime);

                    console.log(result.card.prime);
                    var checkout = {
                            prime: result.card.prime,
                            order: {
                                shipping: "delivery",
                                payment: "credit_card",
                                subtotal: 1234,
                                freight: 14,
                                total: 1300,
                                recipient: {
                                    name: "yuhan",
                                    phone: "0987654321",
                                    email: "yuhan@yuhan",
                                    address: "市政府站",
                                    time: "morning"
                                }
                            },
                            list: [{
                                id: "201807202157",
                                name: "活力花紋長筒牛仔褲",
                                price: 1299,
                                color: {
                                    code: "DDF0FF",
                                    name: "淺藍"
                                },
                                size: "M",
                                qty: 1
                            }]
                        }
                        // const urlParams = new URLSearchParams(window.location.search);
                        // const accessToken = urlParams.get('accessToken');
                    var xmlhttp = new XMLHttpRequest();
                    accessToken = localStorage.getItem("accessToken")
                    xmlhttp.open("POST", "/order/checkout", true);
                    xmlhttp.setRequestHeader('Content-Type', 'application/json');
                    xmlhttp.setRequestHeader("Authorization", "Bearer " + accessToken);
                    xmlhttp.onload = function() {
                        var id = JSON.parse(xmlhttp.responseText).data.number[0].id;
                        console.log(JSON.parse(xmlhttp.responseText).data.number[0].id);
                        if (!id) {
                            alert("付款失敗");
                        } else {
                            var url = ("./thank.html?id=" + id)
                            window.location.assign(url)
                        }
                    }

                    xmlhttp.send(JSON.stringify({
                        checkout
                    }));
                    var command = `
                    Use following command to send to server \n\n
                    curl -X POST https://sandbox.tappaysdk.com/tpc/payment/pay-by-prime \\
                    -H 'content-type: application/json' \\
                    -H 'x-api-key: partner_6ID1DoDlaPrfHw6HBZsULfTYtDmWs0q0ZZGKMBpp4YICWBxgK97eK3RM' \\
                    -d '{
                        "partner_key": "partner_6ID1DoDlaPrfHw6HBZsULfTYtDmWs0q0ZZGKMBpp4YICWBxgK97eK3RM",
                        "prime": "${result.card.prime}",
                        "amount": "1",
                        "merchant_id": "GlobalTesting_CTBC",
                        "details": "Some item",
                        "cardholder": {
                            "phone_number": "+886923456789",
                            "name": "王小明",
                            "email": "LittleMing@Wang.com",
                            "zip_code": "100",
                            "address": "台北市天龍區芝麻街1號1樓",
                            "national_id": "A123456789"
                        }
                    }'`.replace(/                /g, '')

                    // document.getElementById("prime").value = result.card.prime;
                    // xmlhttp.send(result.card.prime);
                    // document.querySelector('#curl').innerHTML = command
                    // xmlhttp.open("POST", "/order/checkout", false);

                })
            })

            function setNumberFormGroupToError(selector) {
                $(selector).addClass('has-error')
                $(selector).removeClass('has-success')
            }

            function setNumberFormGroupToSuccess(selector) {
                $(selector).removeClass('has-error')
                $(selector).addClass('has-success')
            }

            function setNumberFormGroupToNormal(selector) {
                $(selector).removeClass('has-error')
                $(selector).removeClass('has-success')
            }

            function forceBlurIos() {
                if (!isIos()) {
                    return
                }
                var input = document.createElement('input')
                input.setAttribute('type', 'text')
                    // Insert to active element to ensure scroll lands somewhere relevant
                document.activeElement.prepend(input)
                input.focus()
                input.parentNode.removeChild(input)
            }

            function isIos() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            }
        </script>
</body>



<footer id=id_footer>
    <div id="foot_nav">
        <ul class="clearfix_footer">
            <div>
                <a href="#" class=item>關於stylish  |</a>

                <a href="#" class="item">服務條款 |</a>

                <a href="#" class=item>隱私政策 |</a>

                <a href="#" class=item>聯絡我們 |</a>
                <a href="#" class=item>FQA</a>
            </div>
            <img class="social" src="./img/line.png" alt="line">
            <img class="social" src="./img/twitter.png" alt="line">
            <img class="social" src="./img/facebook.png" alt="line">
            <h2 class=copyright> © 2018. All rights reserved.</h2>
        </ul>

    </div>
</footer>

</body>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    console.log(id)
    var xmlhttp2 = new XMLHttpRequest();
    xmlhttp2.open("get", "/api/1.0/products/details?id=" + id, true)
    xmlhttp2.send(null);
    xmlhttp2.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            var obj_id = JSON.parse(xmlhttp2.responseText)
            console.log(obj_id)
                // console.log(obj_id.chad)
                //取title
            var titleDiv = document.createElement("div");
            var titleContent = document.createTextNode(obj_id.Data[0].title);
            titleDiv.appendChild(titleContent);
            document.getElementById("title").appendChild(titleDiv)


            //取id
            var IDDiv = document.createElement("div");
            var IDContent = document.createTextNode(obj_id.Data[0].id);
            IDDiv.appendChild(IDContent);
            document.getElementById("id").appendChild(IDDiv);

            //取price
            var priceDiv = document.createElement("div");
            var priceContent = document.createTextNode("TWD." + obj_id.Data[0].price);
            priceDiv.appendChild(priceContent);
            document.getElementById("price").appendChild(priceDiv);

            //顏色
            // var colorDiv = document.createElement("div");
            var color_backgroundColor = ("#" + obj_id.Data[0].colors[0].code);
            // var colorContent = ("#" + obj_id.Data[0].colors[0].code);
            console.log(color_backgroundColor);
            // colorDiv.style.backgroundColor = (colorContent);
            document.getElementsByClassName("color_item")[0].style.backgroundColor = (color_backgroundColor);

            //尺寸
            // var sizeDiv = document.createElement("div");
            var size_split = obj_id.Data[0].sizes
                // console.log("gg" + obj_id.Data[0].sizes)
            for (var i = 0; i < size_split.length; i++) {
                var sizeDiv = document.createElement("div");

                var sizeContent = document.createTextNode(size_split[i]);
                console.log(size_split[i])
                sizeDiv.className = "size_item_1"
                    // console.log(sizeContent[1])
                    // console.log(sizeContent)
                sizeDiv.appendChild(sizeContent)
                    // console.log(sizeDiv)
                document.getElementById("size").appendChild(sizeDiv);
            }



            // var sizeDiv_2 = document.createElement("div");
            // var sizeContent_2 = document.createTextNode(size_split[1]);
            // sizeDiv_1.appendChild(sizeContent_2);
            // document.getElementsByClassName("size_word_2")[0].appendChild(sizeDiv_2);

            //texture
            var textureDiv = document.createElement("div");
            var textureContent = document.createTextNode(obj_id.Data[0].texture);
            textureDiv.appendChild(textureContent);
            document.getElementById("texture").appendChild(textureDiv);

            //wash
            var washDiv = document.createElement("div");
            var washContent = document.createTextNode(obj_id.Data[0].wash);
            washDiv.appendChild(washContent);
            document.getElementById("wash").appendChild(washDiv);

            //place
            var placeDiv = document.createElement("div");
            var placeContent = document.createTextNode(obj_id.Data[0].place);
            placeDiv.appendChild(placeContent);
            document.getElementById("place").appendChild(placeDiv);

            //main_image
            var main_image_src = ("./porfuct_list_uploads/" + obj_id.Data[0].main_image);
            document.getElementsByClassName("main_image")[0].src = (main_image_src);

            //images
            var images = obj_id.Data[0].images.split(",")
            images_src_2 = ("./porfuct_list_uploads/" + images[0]);
            images_src_3 = ("./porfuct_list_uploads/" + images[1]);
            document.getElementById("picture_2").src = (images_src_2);
            document.getElementById("picture_3").src = (images_src_3);

            // let colorDiv = document.createElement("div");
            // //幫新增的div賦予一個classname
            // colorDiv.className = "rectangle-4"
            // colorDiv.style.backgroundColor = ("#" + obj.Data[i].colors[j].code);
            // status[i].appendChild(colorDiv)
            // console.log("i : " + i + " " + colorDiv.style.backgroundColor)
        }
    }
    $("input[type='number']").inputSpinner()



    // var xmlhttp = new XMLHttpRequest();
    // xmlhttp.open("post", "/order/checkout", true)
    // xmlhttp.send(null);
</script>

</html>